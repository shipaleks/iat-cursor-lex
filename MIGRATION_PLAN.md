# План перехода на Эксперимент v2 (Эстетика)

Этот документ описывает шаги и изменения, необходимые для перехода от первоначальной версии эксперимента к версии v2, сфокусированной на оценке эстетики генеративных моделей изображений.

*Примечание: Статус каждого основного шага в разделе "План Реализации" будет обновляться с `[TODO]` на `[DONE]` по мере выполнения соответствующих подзадач.*

## 1. Цель Эксперимента v2

*   Сравнение восприятия эстетики изображений, сгенерированных различными моделями (около 300 изображений на модель, всего ~600).
*   Оценка одного основного фактора — "эстетичность" — с использованием расширенного набора слов.
*   Создание структуры эксперимента, подходящей для длительных сессий одним пользователем, с минимизацией повторений задач.

## 2. Ключевые Отличия от v1

*   **Количество изображений:** Увеличено с ~80 до ~600.
*   **Источник изображений:** Данные (`dictionary.tsv` или аналог) должны содержать информацию о `модели` для каждого изображения (извлекаемую из `fileName`). Поля `концепт` и `антоним` больше не используются для логики подбора слов.
*   **Набор слов:** Вместо 8 слов (4 фактора) используется новый набор из 46 слов, относящихся к 6 факторам эстетики, с позитивной и негативной коннотацией.
*   **Структура испытаний:** Вместо полного перебора (все слова для каждой картинки), для каждой картинки случайно выбирается **3 реальных слова** из пула 46 и генерируется **3 не-слова**. Итого 6 испытаний на изображение.
*   **Формирование сессии:** Сессия состоит из N (например, 10) изображений, для каждого из которых генерируется 6 испытаний. Итого N*6 (например, 60) испытаний за сессию.
*   **Отслеживание прогресса:** Для минимизации повторов отслеживается список `fileName` изображений, показанных пользователю (`completedImages`). При формировании новой сессии предпочтение отдается еще не показанным изображениям. Выбор слов для изображения остается случайным при каждом показе.

## 3. Технические Решения

*   **Контроль версий:** Будет создана новая ветка `experiment-v2` в текущем Git репозитории. Старая версия останется в ветке `main` (или `master`). Рекомендуется поставить тег на последний коммит v1 (e.g., `git tag experiment-v1-final`).
*   **Firebase:** Будет создан **новый проект Firebase** для изоляции данных v2 от v1. Потребуется новая конфигурация Firebase для веб-приложения и новый ключ сервисного аккаунта (если используются серверные скрипты).
*   **Сохранение данных v1:** Данные v1 останутся нетронутыми в старом проекте Firebase.
*   **Архивация кода v1 (опционально):** Можно создать zip-архив проекта перед началом работы над v2.

## 4. План Реализации (Шаги)

*Статус каждого основного шага будет обновляться с `[TODO]` на `[DONE]` по мере выполнения всех его подзадач.*

1.  **[TODO] Подготовка Данных:**
    *   [TODO] 1.1. Подготовить источник данных изображений (например, `/data/dictionary_v2.tsv`) для ~600 изображений. Убедиться, что `fileName` содержит информацию о модели.
    *   [TODO] 1.2. Создать файл `src/utils/wordBank.ts`.
    *   [TODO] 1.3. Определить интерфейс `AestheticWord { factor: number; word: string; connotation: 'positive' | 'negative'; }` в `wordBank.ts`.
    *   [TODO] 1.4. Наполнить `wordBank.ts` массивом `AESTHETIC_WORDS` (46 слов).
    *   [TODO] 1.5. Создать и экспортировать вспомогательные массивы `POSITIVE_AESTHETIC_WORDS` и `NEGATIVE_AESTHETIC_WORDS` в `wordBank.ts`.
2.  **[TODO] Обновление Типов (`src/types.ts`):**
    *   [TODO] 2.1. Обновить тип `Trial`: изменить `wordType` на `'aesthetic' | 'non-word'`. Добавить/проверить поле `imageFileName: string`.
    *   [TODO] 2.2. Обновить тип `ParticipantProgress` (или аналогичный): изменить тип поля `completedImages` на `string[]`.
    *   [TODO] 2.3. Обновить тип `Session`: убедиться, что `imageIds` соответствует `fileName[]` (если используется).
3.  **[TODO] Модификация `src/utils/trialGenerator.ts`:**
    *   [TODO] 3.1. Импортировать `AESTHETIC_WORDS` (и, возможно, `POSITIVE/NEGATIVE_AESTHETIC_WORDS`) из `wordBank.ts`. Удалить импорт и использование `FACTOR_WORDS`.
    *   [TODO] 3.2. Адаптировать функцию `loadImages` для чтения нового источника данных (из шага 1.1), игнорируя `target`/`antonym`, но сохраняя `fileName` и `model`. Убедиться, что `IMAGES` содержит `ImageData[]` с нужными полями.
    *   [TODO] 3.3. Переработать функцию `createTrialsForImage(image: ImageData)`:
        *   [TODO] 3.3.1. Определить константы `NUM_REAL_WORDS_PER_IMAGE = 3`, `NUM_NON_WORDS_PER_IMAGE = 3`.
        *   [TODO] 3.3.2. Реализовать выборку 3 случайных слов из `AESTHETIC_WORDS`.
        *   [TODO] 3.3.3. Реализовать генерацию 3 уникальных не-слов с помощью `generateNonWord`, используя выбранные реальные слова как базу.
        *   [TODO] 3.3.4. Создать и вернуть массив из 6 объектов `Trial` (тип из п. 2.1), установив `wordType: 'aesthetic'` для реальных слов и `wordType: 'non-word'` для не-слов, и заполнить `imageFileName`.
    *   [TODO] 3.4. Переработать функцию `createSession(participantId, completedImages: string[], isTestSession)`:
        *   [TODO] 3.4.1. Убедиться, что `completedImages` обрабатывается как массив `fileName` (`string[]`).
        *   [TODO] 3.4.2. Реализовать логику выбора N изображений (например, N=10): отфильтровать `IMAGES` по `completedImages`, выбрать N случайных из не пройденных; если их мало, выбрать N случайных из всех `IMAGES`.
        *   [TODO] 3.4.3. Вызвать `createTrialsForImage` для каждого из N выбранных изображений.
        *   [TODO] 3.4.4. Собрать все N*6 испытаний, перемешать их.
        *   [TODO] 3.4.5. Вернуть объект `Session` (тип из п. 2.3) с обновленным списком `trials` и `totalTrials`.
4.  **[TODO] Модификация `src/firebase/service.tsx`:**
    *   [TODO] 4.1. Адаптировать `saveTrialResult`: убедиться, что тип аргумента соответствует `Trial` из п. 2.1 и что сохраняются `imageFileName` и корректный `wordType`.
    *   [TODO] 4.2. Адаптировать `updateParticipantProgress`: функция должна принимать `completedImages: string[]` и сохранять этот массив `fileName` в Firestore.
    *   [TODO] 4.3. Адаптировать `getParticipantProgress`: функция должна читать поле `completedImages` как массив `string[]` из Firestore и возвращать объект типа `ParticipantProgress` из п. 2.2.
5.  **[TODO] Модификация UI Компонентов:**
    *   [TODO] 5.1. `src/components/trial/ExperimentScreen.tsx`: В `handleResponse` обновить проверку `isCorrect`, используя `wordType === 'aesthetic'` и `wordType === 'non-word'`. Убедиться, что тип `trialState.trial` соответствует `Trial` из п. 2.1.
    *   [TODO] 5.2. `src/App.tsx`: В `handleExperimentComplete` сделать `setCanContinue(true)` или полностью убрать логику `canContinue` и связанные с ней состояния/пропсы.
6.  **[TODO] Настройка Окружения и Тестирование:**
    *   [TODO] 6.1. Обновить конфигурацию Firebase в коде (`src/firebase/config.tsx` и/или `.env` файлы) на данные **нового** проекта Firebase.
    *   [TODO] 6.2. Заменить старый ключ сервисного аккаунта (`firebase-key.json`?) на новый (если применимо) и обновить пути в скриптах.
    *   [TODO] 6.3. Провести полное тестирование флоу: запуск, ввод никнейма, прохождение нескольких сессий, проверка сохранения результатов в Firestore (коллекции `trials`, `progress`), проверка корректного выбора изображений для новых сессий.
    *   [TODO] 6.4. Проверить работу серверных скриптов (если они используются) с новым ключом и новой структурой данных.

## 5. Структура Данных Firestore (v2) - Ожидаемая

*   **`nicknames`:** (Без изменений?) Документ(ID=nickname) -> `{ userId, lastUpdated }`
*   **`progress`:** Документ(ID=userId) -> `{ nickname, completedImages: string[], totalSessions, lastSessionTimestamp }` (*Изменение*: `completedImages` теперь массив `fileName`).
*   **`trials`:** Документ(ID=auto) -> `{ participantId, participantNickname, imageFileName: string, word: string, wordType: 'aesthetic' | 'non-word', isCorrect: boolean, reactionTimeMs: number, timestamp: Timestamp }` (*Изменения*: `wordType`, `imageFileName`).
*   **`sessions`:** (Без изменений?) Документ(ID=userId ?) -> `{ nickname, totalTrials, correctTrials, totalTimeMs, timestamp }`
*   **`leaderboard`:** (Без изменений?) Документ(ID=userId) -> `{ nickname, score, totalTrials, totalCorrect, totalTimeMs, lastUpdated }`

## 6. Настройка Окружения для v2 (Чек-лист)

1.  [ ] Создать новый проект в Firebase Console.
2.  [ ] Включить Firestore и анонимную аутентификацию в новом проекте.
3.  [ ] Сгенерировать и скачать новый файл конфигурации веб-приложения Firebase.
4.  [ ] (Если нужно) Сгенерировать и скачать новый ключ сервисного аккаунта Firebase.
5.  [ ] Создать новую ветку в Git: `git checkout -b experiment-v2`.
6.  [ ] Поставить тег на старую версию: `git tag experiment-v1-final`.
7.  [ ] Обновить конфигурационные файлы в проекте (`.env.local`, `.env`, `src/firebase/config.tsx`, `firebase-key.json`?) новыми данными.
8.  [ ] Установить зависимости: `npm install` (или `yarn`).
9.  [ ] Запустить проект локально: `npm run dev` (или `yarn dev`).

---

*Этот план может быть дополнен по мере необходимости.* 